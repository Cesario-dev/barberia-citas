<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario de {{ nombre }}</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        body {
            margin: 0;
            background-color: black;
            color: white;
        }
        td, th {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .ocupado {
            background: black;
            color: white;
        }
        .disponible {
            background: #EFB810;
        }
        .bloqueado {
            background: #ccc;
            color: #555;
        }
        a {
            display: inline-block;
            margin-top: 4px;
            padding: 4px 8px;
            font-size: 0.85em;
            background: #333;
            color: white;
            border-radius: 4px;
            text-decoration: none;
        }
        a:hover {
            background: #555;
        }
        /* Estilo modal */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        #modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }
        #modal-content label {
        color: black;
        }
        #modal-content input {
            color: black; /* para el texto que escribe el usuario */
        }
        #cerrar {
            margin-top: 15px;
            padding: 8px 16px;
            background: #e6b800;
            border: none;
            border-radius: 5px;
            color: black;
            cursor: pointer;
        }
        #cerrar:hover {
            background: #ffcc00;
        }
        .btn-agendar {
            background: #333;
            color: white;
        }
        #confirm-msg {
            white-space: pre-line;
        }
        .hora-label {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 4px; /* espacio entre hora y botÃ³n */
            display: block;
        }
        .btn-contabilidad { 
            background: #2b8; 
            color:#fff; 
            padding:8px; 
            border-radius:8px; 
            text-decoration:none; 
        }
    </style>
</head>
<body>

<h2>Calendario de {{ nombre }}</h2>
<a href="{{ url_for('admin_panel') }}" style="display:inline-block;margin-bottom:15px;padding:8px 12px;background:#007bff;color:white;text-decoration:none;border-radius:5px;">
    â¬… Volver al panel
</a>
{% if es_admin %}
  <a href="{{ url_for('contabilidad_barbero', peluquero_id=peluquero_id) }}" class="btn-contabilidad">
    ðŸ“Š Contabilidad de {{ nombre }}
  </a>
{% endif %}
{% if not es_admin %}
  <a href="{{ url_for('contabilidad_barbero') }}" class="btn-contabilidad">
    ðŸ’° Ver mi contabilidad
  </a>
{% endif %}
{% if es_admin %}
    <form action="{{ url_for('liberar_todo', peluquero_id=peluquero_id) }}" method="post">
    <button type="submit" class="btn-liberar">
        ðŸ”“ Liberar todas las celdas (excepto fijadas y bloqueadas)
    </button>
</form>
{% endif %}

<div style="margin-bottom:10px;">
  <a href="?semana=0"
     style="{{ 'font-weight:bold' if semana == 0 else '' }}">
     Semana actual
  </a>
  |
  <a href="?semana=1"
     style="{{ 'font-weight:bold' if semana == 1 else '' }}">
     Semana siguiente
  </a>
</div>

<p>
  Semana del {{ inicio_semana.strftime('%d/%m/%Y') }}
  al {{ fin_semana.strftime('%d/%m/%Y') }}
</p>
    
<table>
    <thead>
        <tr>
            <th>Hora / DÃ­a</th>
            {% for dia in dias %}
                <th style="text-transform:uppercase; font-weight:bold;">
                    {{ dia|capitalize }}<br>
                    <span style="font-size:0.9em;">{{ dias_con_fechas[dia] }}</span>
                    <form action="{{ url_for('bloquear_dia_completo', peluquero_id=peluquero_id) }}" method="post" style="margin-top:5px;">
                        <input type="hidden" name="dia" value="{{ dia }}">
                        <button type="submit" style="font-size:12px; padding:2px 6px; background:#ff5050; color:white; border:none; border-radius:4px; cursor:pointer;">
                            Bloquear dÃ­a
                        </button>
                    </form>
                </th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for hora in horas %}
        <tr>
            <td>{{ hora }}</td>
            {% for dia in dias %}
                {% if (dia, hora) in ocupados %}
                    <td class="ocupado">
                        <strong>{{ ocupados[(dia, hora)]['nombre'] }}</strong><br>
                            {% if es_admin %}
                            ðŸ“ž <a href="https://wa.me/57{{ ocupados[(dia, hora)]['telefono'] }}"
                                  target="_blank"
                                  style="color: #25D366; text-decoration: none;">
                                  {{ ocupados[(dia, hora)]['telefono'] }}
                                </a>
                            {% endif %}
                            {% if es_admin %}
                                <form action="{{ url_for('toggle_fijo', cita_id=ocupados[(dia, hora)]['id']) }}"
                                      method="post"
                                      style="display:inline;">
                                    <button type="submit" class="btn-fijar">
                                        {% if ocupados[(dia, hora)]['fijo'] %}
                                            Desactivar
                                        {% else %}
                                            Fijar cita
                                        {% endif %}
                                    </button>
                                </form>
                            {% endif %}
                        {% if es_admin %}
                            <a href="{{ url_for('ver_calendario_admin', peluquero_id=peluquero_id, cancelar_dia=dia, cancelar_hora=hora) }}" class="btn-cancelar">Cancelar</a>
                        {% endif %}
                    </td>
                {% elif (dia, hora) in disponibles %}
                    <td class="disponible">
                        {% if es_admin %}
                            <a href="{{ url_for('ver_calendario_admin', peluquero_id=peluquero_id, bloquear_fecha=dias_con_fechas[dia], bloquear_hora=hora, semana_offset=semana_offset) }}">ðŸš« Bloquear</a>
                            <button type="button" class="btn-agendar"
                                data-peluquero="{{ peluquero_id }}"
                                data-dia="{{ dia }}"
                                data-hora="{{ hora }}"
                                data-semana="{{ semana_offset }}">
                                Agendar
                            </button>
                        {% else %}
                            Disponible
                        {% endif %}
                    </td>
                {% elif (dia, hora) in bloqueados %}
                    <td class="bloqueado">
                        {% if es_admin %}
                            <a href="{{ url_for('ver_calendario_admin', peluquero_id=peluquero_id, reactivar_dia=dia, reactivar_hora=hora) }}">âž• Reactivar</a>
                        {% else %}
                            Bloqueado
                        {% endif %}
                    </td>
                {% else %}
                    <td class="bloqueado">No disponible</td>
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>


<div id="modal" style="display:none;">
    <div id="modal-content">
        <h3>Agendar cita</h3>
        <form id="agendar-form" onsubmit="return false;">
            <input type="hidden" name="semana_offset" id="semana_offset">
            <input type="hidden" name="peluquero_id" id="peluquero_id">
            <input type="hidden" name="dia" id="dia">
            <input type="hidden" name="hora" id="hora">

            <label>Nombre:</label>
            <input type="text" name="nombre" required><br><br>
            <label>Whatsapp:</label>
            <input type="text" name="telefono" required><br><br>

            <button type="submit">Confirmar</button>
            <button type="button" id="cancelar">Cancelar</button>
        </form>
        <button type="button" id="cerrar">Cerrar</button>
        
        <p id="confirm-msg" style="color:black; margin-top:15px; display:none;"></p>
    </div>
</div>

<script>
// Mostrar modal con datos del turno
document.querySelectorAll('.btn-agendar').forEach(btn => {
    btn.addEventListener('click', function() {
        console.log("ðŸŸ¢ BotÃ³n Agendar clicado"); // ðŸ‘ˆ verifica en consola
        document.getElementById('peluquero_id').value = this.dataset.peluquero;
        document.getElementById('dia').value = this.dataset.dia;
        document.getElementById('hora').value = this.dataset.hora;
        document.getElementById('semana_offset').value = this.dataset.semana;
        document.getElementById('modal').style.display = 'flex';
    });
});

// Cerrar modal
document.getElementById('cancelar').addEventListener('click', () => {
    document.getElementById('modal').style.display = 'none';
});
document.getElementById('cerrar').addEventListener('click', () => {
    document.getElementById('modal').style.display = 'none';
});

// Enviar formulario
document.getElementById('agendar-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log("ðŸ“¤ Enviando cita..."); // ðŸ‘ˆ verifica si llega acÃ¡

    const formData = new FormData(this);
    const resp = await fetch("{{ url_for('agendar') }}", {
        method: 'POST',
        body: formData
    });

    const data = await resp.json();
    console.log("ðŸ“© Respuesta:", data); // ðŸ‘ˆ mira si llega respuesta

    if (data.success) {
        this.style.display = 'none';
        const msg = document.getElementById('confirm-msg');
        msg.textContent = data.message;
        msg.style.display = 'block';
        setTimeout(() => location.reload(), 2500);
    } else {
        alert(data.message || "Error al agendar");
    }
});
</script>
<script>
function setSemana(valor) {
    document.getElementById("semana_offset").value = valor;
    location.reload(); // luego lo refinamos
}
</script>
</body>
</html>
